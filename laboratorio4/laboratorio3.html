<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Snake WebGL</title>
  <style>
    body {
      font-family: sans-serif;
      background: #ddd;
      padding: 20px;
    }

    canvas {
      background: #fff;
      border-radius: 6px;
      display: block;
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <h2>Juego de la Viborita</h2>
  <h3>Puntuación: <span id="puntuacion">0</span></h3>

  <canvas id="webglcanvas" width="500" height="500"></canvas>
  <img src="manzana.png" id="imagenTextura" hidden />
  <img src="cabezasnake.png" id="imagenTextura2" hidden />
  <img src="cuerposnake2.png" id="imagenTextura3" hidden />
  <img src="fondosnake.jpg" id="imagenTextura4" hidden />

  <script id="vs" type="vertex">
    #version 300 es
    precision mediump float;
    uniform mat4 uMatrizProyeccion;
    uniform mat4 uMatrizVista;
    uniform mat4 uMatrizModelo;
    layout(location = 0) in vec2 aVertices;
    layout(location = 1) in vec2 aCoordenadasDeTextura;
    out vec2 vCoordenadasDeTextura;
    void main() {
        vCoordenadasDeTextura = aCoordenadasDeTextura;  
        gl_Position = uMatrizProyeccion *  uMatrizModelo * uMatrizVista *vec4(aVertices, 0.0, 1.0);
    }
  </script>

  <script id="fs" type="fragment">
    #version 300 es
    precision mediump float;
    uniform sampler2D uUnidadDeTextura;
    in vec2 vCoordenadasDeTextura;
    out vec4 color;
    void main() {
        color = texture(uUnidadDeTextura, vCoordenadasDeTextura); 
    }
  </script>

  <script>
    let gl, canvas;
    let programaID, uColor, uMatrizProyeccion, uMatrizModelo, uUnidadDeTextura;
    let VAO2, manzanaVAO, fondoVAO;
    let MatrizProyeccion = new Float32Array(16);
    let MatrizModelo = new Float32Array(16);
    let MatrizVista = new Float32Array(16);
    identidad(MatrizVista);  // función que ya tienes para poner identidad


    let snake = [{ x: 0, y: 0 }];
    let direccion = { x: 1, y: 0 };
    let comida = { x: 5, y: 5 };
    let cont = 0;
    let texturaVibora, texturaCuerpo, texturafondo;
    let codigoDeTextura;
    let VAOcuerpo;
    function toRadians(grados) {
      return grados * Math.PI / 180;
    }

    function identidad(r) {
      r[0] = 1; r[4] = 0; r[8] = 0; r[12] = 0;
      r[1] = 0; r[5] = 1; r[9] = 0; r[13] = 0;
      r[2] = 0; r[6] = 0; r[10] = 1; r[14] = 0;
      r[3] = 0; r[7] = 0; r[11] = 0; r[15] = 1;
    }

    function traslacion(matriz, tx, ty, tz) {
      let r = new Array(16);
      r[0] = 1; r[4] = 0; r[8] = 0; r[12] = tx;
      r[1] = 0; r[5] = 1; r[9] = 0; r[13] = ty;
      r[2] = 0; r[6] = 0; r[10] = 1; r[14] = tz;
      r[3] = 0; r[7] = 0; r[11] = 0; r[15] = 1;
      multiplica(matriz, matriz, r);
    }

    function ortho(r, izq, der, abj, arr, cerca, lejos) {
      r[0] = 2 / (der - izq); r[5] = 2 / (arr - abj); r[10] = -2 / (lejos - cerca); r[15] = 1;
      r[12] = -(der + izq) / (der - izq);
      r[13] = -(arr + abj) / (arr - abj);
      r[14] = -(lejos + cerca) / (lejos - cerca);
      r[1] = r[2] = r[3] = r[4] = r[6] = r[7] = r[8] = r[9] = r[11] = 0;
    }

    function multiplica(c, a, b) {
      let r = new Array(16);
      for (let i = 0; i < 4; i++) {
        for (let j = 0; j < 4; j++) {
          let s = 0;
          for (let k = 0; k < 4; k++) s += a[i + k * 4] * b[k + j * 4];
          r[i + j * 4] = s;
        }
      }
      for (let i = 0; i < 16; i++) c[i] = r[i];
    }
    function escalacion(m, sx, sy, sz) {
      let r = new Array(16);
      r[0] = sx; r[4] = 0; r[8] = 0; r[12] = 0;
      r[1] = 0; r[5] = sy; r[9] = 0; r[13] = 0;
      r[2] = 0; r[6] = 0; r[10] = sz; r[14] = 0;
      r[3] = 0; r[7] = 0; r[11] = 0; r[15] = 1;
      multiplica(m, m, r);
    }

    function rotacionZ(matriz, theta) {
      let r = new Array(16);
      let c = Math.cos(toRadians(theta));
      let s = Math.sin(toRadians(theta));
      r[0] = c; r[4] = -s; r[8] = 0; r[12] = 0;
      r[1] = s; r[5] = c; r[9] = 0; r[13] = 0;
      r[2] = 0; r[6] = 0; r[10] = 1; r[14] = 0;
      r[3] = 0; r[7] = 0; r[11] = 0; r[15] = 1;
      multiplica(matriz, matriz, r);
    }

    class Rectangulo {
      constructor(gl, x1, y1, x2, y2) {
        let vertices = [x1, y1, x2, y1, x2, y2, x1, y2];
        let coord_textura = [0, 0, 1, 0, 1, 1, 0, 1];

        this.rectanguloVAO = gl.createVertexArray();
        gl.bindVertexArray(this.rectanguloVAO);

        let buf = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, buf);
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertices), gl.STATIC_DRAW);
        gl.enableVertexAttribArray(0);
        gl.vertexAttribPointer(0, 2, gl.FLOAT, false, 0, 0);

        let texBuf = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, texBuf);
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(coord_textura), gl.STATIC_DRAW);
        gl.enableVertexAttribArray(1);
        gl.vertexAttribPointer(1, 2, gl.FLOAT, false, 0, 0);

        gl.bindVertexArray(null);
      }
    }

    function cargarTextura(gl, idImagen, callback) {
      const img = document.getElementById(idImagen);
      if (img.complete) {
        callback(img);
      } else {
        img.onload = () => callback(img);
      }
    }

    function leeLaTextura(gl, img, textura) {
      gl.bindTexture(gl.TEXTURE_2D, textura);
      gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);
      gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, img);
      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.REPEAT);
      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.REPEAT);
      gl.bindTexture(gl.TEXTURE_2D, null);
    }

    function dibujarFondo() {
      identidad(MatrizModelo);
      gl.uniformMatrix4fv(uMatrizModelo, false, MatrizModelo);
      gl.activeTexture(gl.TEXTURE0);
      gl.bindTexture(gl.TEXTURE_2D, texturafondo);
      gl.uniform1i(uUnidadDeTextura, 0);
      gl.bindVertexArray(fondoVAO);
      gl.drawArrays(gl.TRIANGLE_FAN, 0, 4);
      gl.bindVertexArray(null);
    }

    function dibujarManzana(x, y) {
      identidad(MatrizModelo);
      traslacion(MatrizModelo, x, y, 0);
      gl.uniformMatrix4fv(uMatrizModelo, false, MatrizModelo);
      gl.activeTexture(gl.TEXTURE0);
      gl.bindTexture(gl.TEXTURE_2D, codigoDeTextura);
      gl.uniform1i(uUnidadDeTextura, 0);
      gl.bindVertexArray(manzanaVAO);
      gl.drawArrays(gl.TRIANGLE_FAN, 0, 4);
      gl.bindVertexArray(null);
    }

    function vibora(x, y, angulo = 0, esCabeza) {
      identidad(MatrizModelo);
      traslacion(MatrizModelo, x, y, 0);
      rotacionZ(MatrizModelo, angulo);
      gl.uniformMatrix4fv(uMatrizModelo, false, MatrizModelo);
      gl.activeTexture(gl.TEXTURE0);
      gl.bindTexture(gl.TEXTURE_2D, esCabeza ? texturaVibora : texturaCuerpo);
      gl.uniform1i(uUnidadDeTextura, 0);
      gl.bindVertexArray(esCabeza ? VAO2 : VAOcuerpo);
      //traslacion(MatrizModelo,x,y,0);
      //escalacion(MatrizModelo, 1.8, 1.8, 1);
      gl.drawArrays(gl.TRIANGLE_FAN, 0, 6);
      gl.bindVertexArray(null);
    }

    function renderizar() {
      gl.clear(gl.COLOR_BUFFER_BIT);
      dibujarFondo();
      dibujarManzana(comida.x, comida.y);
      const cabeza = snake[0];
      let ang = 0;
      if (direccion.x === 1) ang = 0;
      if (direccion.x === -1) ang = 180;
      if (direccion.y === 1) ang = 90;
      if (direccion.y === -1) ang = 270;
      vibora(cabeza.x, cabeza.y, ang, true);
      for (let i = 1; i < snake.length; i++) {
        vibora(snake[i].x, snake[i].y, ang, false);
      }
      requestAnimationFrame(renderizar);
    }

    function actualizar() {
      const cabeza = { x: snake[0].x + direccion.x, y: snake[0].y + direccion.y };
      snake.unshift(cabeza);
      if (Math.abs(cabeza.x - comida.x) < 1 && Math.abs(cabeza.y - comida.y) < 1) {
        //alert(`Cabeza: (${cabeza.x}, ${cabeza.y}), Comida: (${comida.x}, ${comida.y})`);

        cont++;
        document.getElementById("puntuacion").textContent = cont;
        comida.x = Math.floor(Math.random() * 14) - 7;
        comida.y = Math.floor(Math.random() * 14) - 7;
      } else snake.pop();
      if (Math.abs(cabeza.x) > 7 || Math.abs(cabeza.y) > 12) {
        snake = [{ x: 0, y: 0 }];
        direccion = { x: 1, y: 0 };
        alert("Chocaste con la pared");
        cont = 0;
        document.getElementById("puntuacion").textContent = cont;
        comida.x = 5; comida.y = 5;
      }
    }

    function ciclo() {
      actualizar();
      renderizar();
      setTimeout(() => requestAnimationFrame(ciclo), 100);
    }

    function teclado(e) {
      if (e.key === "ArrowUp" && direccion.y === 0) direccion = { x: 0, y: 1 };
      if (e.key === "ArrowDown" && direccion.y === 0) direccion = { x: 0, y: -1 };
      if (e.key === "ArrowLeft" && direccion.x === 0) direccion = { x: -1, y: 0 };
      if (e.key === "ArrowRight" && direccion.x === 0) direccion = { x: 1, y: 0 };
    }

    function main() {
      canvas = document.getElementById("webglcanvas");
      gl = canvas.getContext("webgl2");
      if (!gl) { alert("WebGL2 no soportado"); return; }

      const vs = gl.createShader(gl.VERTEX_SHADER);
      gl.shaderSource(vs, document.getElementById("vs").text.trim());
      gl.compileShader(vs);

      const fs = gl.createShader(gl.FRAGMENT_SHADER);
      gl.shaderSource(fs, document.getElementById("fs").text.trim());
      gl.compileShader(fs);

      programaID = gl.createProgram();
      gl.attachShader(programaID, vs);
      gl.attachShader(programaID, fs);
      gl.linkProgram(programaID);
      gl.useProgram(programaID);

      uColor = gl.getUniformLocation(programaID, "uColor");
      uMatrizProyeccion = gl.getUniformLocation(programaID, "uMatrizProyeccion");
      uMatrizModelo = gl.getUniformLocation(programaID, "uMatrizModelo");
      uUnidadDeTextura = gl.getUniformLocation(programaID, "uUnidadDeTextura");
      let uMatrizVista = gl.getUniformLocation(programaID, "uMatrizVista");
      gl.uniformMatrix4fv(uMatrizVista, false, MatrizVista);



      gl.uniform4f(uColor, 1.0, 1.0, 1.0, 1.0);
      ortho(MatrizProyeccion, -15, 15, -15, 15, -1, 1);
      gl.uniformMatrix4fv(uMatrizProyeccion, false, MatrizProyeccion);

      VAO2 = new Rectangulo(gl, -1, -1, 1.5, 1).rectanguloVAO;
      VAOcuerpo = new Rectangulo(gl, -0.8, -0.8, 0.8, 0.8).rectanguloVAO;

      manzanaVAO = new Rectangulo(gl, -1, -1, 1, 1).rectanguloVAO;
      fondoVAO = new Rectangulo(gl, -15, -15, 15, 15).rectanguloVAO;

      codigoDeTextura = gl.createTexture();
      texturaVibora = gl.createTexture();
      texturaCuerpo = gl.createTexture();
      texturafondo = gl.createTexture();

      cargarTextura(gl, "imagenTextura", img => leeLaTextura(gl, img, codigoDeTextura));
      cargarTextura(gl, "imagenTextura2", img => leeLaTextura(gl, img, texturaVibora));
      cargarTextura(gl, "imagenTextura3", img => leeLaTextura(gl, img, texturaCuerpo));
      cargarTextura(gl, "imagenTextura4", img => leeLaTextura(gl, img, texturafondo));

      gl.clearColor(0, 1, 0, 1);
      gl.enable(gl.BLEND);
      gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);

      document.addEventListener("keydown", teclado);
      ciclo();
    }

    window.onload = main;
  </script>
</body>

</html>